name: JP Upload

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  dump-jp-update:
    environment: "GitHub Action"
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13.x'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Get APK & Dumper
        run: python getApkData.py --region jp
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Run Dumper
        run: python getJPVersion.py

      - name: Get version string for release
        id: get_version
        shell: bash
        run: |
          raw_game_url=$(jq -r '.ServerInfoDataUrl' jp_data/config.json)
          raw_catalog=$(jq -r '.ConnectionGroups[0].OverrideConnectionGroups | .[-1].AddressablesCatalogUrlRoot' jp_data/config.json)
          
          game_url=$(echo "$raw_game_url" | sed -n 's#.*/\([^/]*\)\.json#\1#p')
          catalog=$(echo "$raw_catalog" | sed -n 's#.*/\([^/]*\)$#\1#p')
          
          version_string="${game_url}_${catalog}"
          echo "version=$version_string" >> $GITHUB_OUTPUT
          echo "Version string: $version_string"

      - name: Find APK and XAPK files
        id: find_files
        shell: bash
        run: |
          # 查找所有apk和xapk文件
          find . -name "*.apk" -o -name "*.xapk" | while read file; do
            echo "Found file: $file"
          done
          
          # 将文件列表保存到输出
          file_list=$(find . -name "*.apk" -o -name "*.xapk" | tr '\n' ' ')
          echo "files=$file_list" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: Release ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            Automated release for version ${{ steps.get_version.outputs.version }}
            
            Contains APK and XAPK files.
          files: |
            *.apk
            *.xapk
